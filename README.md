# Domnenko Aleksey 2021 
## domnenko@mail.ru, 
## telegram: @domnenko_a_n

РЕШЕНИЕ
Github: https://github.com/Domnenko-Aleksey/Finding-Jim-Carrey-on-video

Colab: https://drive.google.com/drive/folders/1VNPK0EzgDDkUbwYaotDnc2Ij2tHbwwx3?usp=sharing

Основное решение - файл 'main.ipynb'
Colab: https://colab.research.google.com/drive/1gO5necL06qOJ7jFoL4HpntaRRHU7_yAd?usp=sharing

Тестирование работоспособности - файл 'test.ipynb'
Colab: https://colab.research.google.com/drive/1694u2IrMXT7F4Z_Ms7vZxdvmsUw-Yj_u?usp=sharing

Полученные данные сохраняются в папке '/files/result'
Видео в формате 'mp4' для файла 'main.ipynb' - прекрасно открывается браузером, проигрывателем MPC-HC
Если с кодеками проблема - поменяйте формат сохранения на 'avi'
Видео в формате 'avi' для файла 'test.ipynb' - если не получилось открыть mp4 для файла 'main.ipynb'

Решение полностью выполняет поставленное перед собой задание, однако подход возможно несколько другой, чем Вы ожидали.
Стоит посмотреть на результирующем видео на 22 секунду 'files/result/result.mp4', оценить скорость выполнения и краткость кода, 
и желание искать другой подход на 90% отпадает.
Крайне важным является момент, что для образца нужна только одна фотография, что ближе к реальным, жизненным условиям.
Понятно, что если усреднить вектор по множеству изображений - точность будет выше.
Ещё один момент - большинство победителей на Kaggle используют готовые модели, а не изобретают велосипед.
Мой подход - аналогичен. Я использовал библиотеку dlib. Считаю её одной из лучших.


ТЕХНИЧЕСКИЕ ОГРАНИЧЕНИЯ

Скачайте файлы обученной модели самостоятельно и разместите их в папке 'files/dlib_models':

dlib_face_recognition_resnet_model_v1.dat
shape_predictor_68_face_landmarks.dat

Можно взять из моего проекта на Colab
https://drive.google.com/drive/folders/1VNPK0EzgDDkUbwYaotDnc2Ij2tHbwwx3?usp=sharing


Рекомендуется запуск на google colab, т.к. там настроена вся необходимая среда.
Крайне не рекомендуется запускать на Windows - потребуется установить и настроить кучу зависимостей для dlib, 
Visual Studio, C++ - Packages CMake tools для Windows, ffmpeg, настроить переменные среды и др.

Для 20 минутного видео необходим объём ОЗУ 24 гигабайта только на тензор видео. 
Таких ресурсов у меня нет. Обрезал видео до 3 минут и смог запустить пример на google colab

Видеоролик mp4 может открываться не всеми проигрывателя, но прекрасно открывается в браузере.
В файле 'test.ipynb' я поставил расширение '.avi' - везде открывается.


ЭКСПЕРИМЕНТ.

Файл: main.ipynb

Как это работает:

1. Загружаем фотографию Джима Керри в анфас с хорошим качеством и типичным изображением лица.
2. С помощью dlib извлекаем признаки и формируем 128 разрядный вектор признаков.
3. Проходим по всем кадрам видео, проверяем каждый кадр на наличие лиц.
4. Если лицо найдено - вычисляем вектор признаков.
5. Находим Евклидово расстояние между вектором лица Джима Керри и найденным вектором.
6. Если Евклидово расстояние менее порога (0.6) - это Джим Керри, помещаем индекс кадров в список DAN.frame_list
7. Перебираем все кадры видео и если текущий кадр есть в списке кадров DAN.frame_list - помещаем тензор кадра в список
8. Переводим список тензоров в тензор numpy 4 ранга и сохраняем видео. 


ВНИМАНИЕ!

Не забудьте указать в настройках свои пути до папок.
